<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de censo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- NAV -->
  <nav class="bg-red-600 p-4">
    <div class="container mx-auto flex justify-between items-center">
      <div class="text-white text-xl font-bold">Censo</div>
      <ul class="flex space-x-4">
        <li><a href="./home.html" class="text-white hover:text-gray-200">Inicio</a></li>
      </ul>
    </div>
  </nav>

  <!-- CONTENIDO -->
  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-8 text-center">Gestión de Censo</h1>

    <!-- BOTONES SECCIONES -->
    <div class="flex justify-center mb-6 space-x-2">
      <button id="btn-buscar" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Buscar</button>
      <button id="btn-cargar" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Cargar</button>
    </div>

    <!-- SECCION BUSCAR -->
    <div id="seccion-buscar" class="bg-white p-6 rounded-lg shadow-md mb-8">
      <h2 class="text-2xl font-bold mb-4">Buscar Censo</h2>
      <form id="form-buscar" class="space-y-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Nombre</label>
            <input type="text" id="buscar-nombre" class="input-field" placeholder="Ej: Ana">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Apellido</label>
            <input type="text" id="buscar-apellido" class="input-field" placeholder="Ej: Pérez">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Desde</label>
            <input type="date" id="fecha-desde" class="input-field">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Hasta</label>
            <input type="date" id="fecha-hasta" class="input-field">
          </div>
        </div>
        <div class="flex justify-end">
          <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Buscar</button>
        </div>
      </form>

      <!-- RESULTADOS -->
      <div id="resultados" class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-300">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Codigo Paciente</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Apellido</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Edad</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Género</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha Ingreso</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Diagnóstico</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Medico</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Especialidad</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aseguradora</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha Alta</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Alta</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Días Ingreso </th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody-resultados" class="bg-white divide-y divide-gray-200">
            <tr>
              <td colspan="13" class="px-4 py-2 text-center text-gray-500">Cargando...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- SECCION CARGAR -->
    <div id="seccion-cargar" class="bg-white p-6 rounded-lg shadow-md hidden">
      <!-- BUSCADOR MEDICOS -->
      <div class="mb-4 flex justify-center">
        <input type="text" id="buscar-medico" placeholder="Buscar médico..." class="px-3 py-2 border rounded w-full md:w-1/3">
      </div>

      <!-- TABLA MEDICOS -->
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-300">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Especialidad</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Acción</th>
            </tr>
          </thead>
          <tbody id="tbody-medicos" class="bg-white divide-y divide-gray-200">
            <tr>
              <td colspan="4" class="px-4 py-2 text-center text-gray-500">Cargando médicos...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

   <!-- MODAL AGREGAR PACIENTE -->
<div id="modalPaciente" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center overflow-auto hidden">
  <div class="bg-white p-6 rounded-lg w-full max-w-4xl mx-4">
    <h2 class="text-2xl font-bold mb-4 text-center">Agregar Paciente</h2>
    <form id="formPaciente" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input type="hidden" name="idmedicos_fk" id="paciente-idmedico">

      <div class="col-span-2">
        <label>Médico</label>
        <input type="text" name="medico_nombre" id="paciente-medico" readonly class="mt-1 w-full px-3 py-2 border rounded bg-gray-100">
      </div>

      <div>
        <label>ID Paciente</label>
        <input name="id_paciente" required maxlength="25" class="mt-1 w-full px-3 py-2 border rounded">
      </div>
      <div>
        <label>Nombre Paciente</label>
        <input name="nombrepaciente" required maxlength="150" class="mt-1 w-full px-3 py-2 border rounded">
      </div>
      <div>
        <label>Apellido Paciente</label>
        <input name="apellidopaciente" required maxlength="150" class="mt-1 w-full px-3 py-2 border rounded">
      </div>
      <div>
        <label>Edad</label>
        <input type="number" name="edad" min="0" required class="mt-1 w-full px-3 py-2 border rounded">
      </div>
      <div>
        <label>Género</label>
        <select name="idgenero_fk" required class="mt-1 w-full px-3 py-2 border rounded">
          <option value="">Seleccione un género</option>
        </select>
      </div>
      <div>
        <label>Fecha Ingreso</label>
        <input type="date" name="fechaingreso" required class="mt-1 w-full px-3 py-2 border rounded">
      </div>
      <div>
        <label>Diagnóstico Paciente</label>
        <textarea name="diagnosticopaciente" maxlength="250" rows="3" required class="mt-1 w-full px-3 py-2 border rounded"></textarea>
      </div>
      <div>
        <label>Especialidad</label>
        <input name="especialidad" readonly class="mt-1 w-full px-3 py-2 border rounded bg-gray-100">
      </div>
      <div>
        <label>Aseguradora</label>
        <input name="aseguradora" maxlength="150" required class="mt-1 w-full px-3 py-2 border rounded">
      </div>

      <div class="col-span-2 flex justify-end space-x-2 mt-4">
        <button type="button" onclick="cerrarModalPaciente()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancelar</button>
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Guardar</button>
      </div>
    </form>
  </div>
</div>
<!-- MODAL MODIFICAR PACIENTE -->
<div id="modalModificar" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center overflow-auto hidden">
  <div class="bg-white p-6 rounded-lg w-full max-w-4xl mx-4">
    <h2 class="text-2xl font-bold mb-4 text-center">Modificar Paciente</h2>
    <form id="formModificar" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <input type="hidden" name="idsenso" id="mod-idsenso">

      <div>
        <label>Nombre Paciente</label>
        <input type="text" name="nombrepaciente" id="mod-nombre" class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>

      <div>
        <label>Apellido Paciente</label>
        <input type="text" name="apellidopaciente" id="mod-apellido" class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>

      <div>
        <label>Edad</label>
        <input type="number" name="edad" id="mod-edad" class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>

      <div>
        <label>Fecha Ingreso</label>
        <input type="date" name="fechaingreso" id="mod-fechaingreso" class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>

      <div>
        <label>Días De Hospitalización</label>
        <input name="diasInstancia" type="number" id="mod-diasInstancia" required min="0" max="200" class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>

      <div>
        <label>Diagnóstico Paciente</label>
        <textarea name="diagnosticopaciente" id="mod-diagnosticopaciente" maxlength="250" rows="3" required class="mt-1 w-full px-3 py-2 border rounded-md"></textarea>
      </div>

      <div>
        <label>Aseguradora</label>
        <input name="aseguradora" id="mod-aseguradora" maxlength="150" required class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>

      <div class="col-span-2 flex justify-end space-x-2 mt-4">
        <button type="button" onclick="cerrarModal()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancelar</button>
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Guardar</button>
      </div>
    </form>
  </div>
</div>


  </div>

  <!-- SCRIPT -->
  <script>
    const API_BASE = "https://backendsenso.onrender.com";

    let medicosData = [];
    let generosData = [];
    let sensoData = [];

    // -----------------------------
    // FUNCIONES MODAL PACIENTE
    // -----------------------------
    function abrirModal(id, nombre, especialidad) {
      document.getElementById("paciente-idmedico").value = id;
      document.getElementById("paciente-medico").value = nombre;
      document.querySelector('input[name="especialidad"]').value = especialidad;
      document.getElementById("modalPaciente").classList.remove("hidden");
    }

    function cerrarModalPaciente() {
      document.getElementById("modalPaciente").classList.add("hidden");
      document.getElementById("formPaciente").reset();
      document.querySelector('input[name="especialidad"]').value = "";
    }

    // -----------------------------
    // CARGAR MÉDICOS
    // -----------------------------
    async function cargarMedicos() {
      try {
        const res = await fetch(`${API_BASE}/medicos/`);
        medicosData = await res.json();
        mostrarMedicos(medicosData);
      } catch(e) { console.error(e); }
    }

    function mostrarMedicos(data) {
      const tbody = document.getElementById("tbody-medicos");
      tbody.innerHTML = "";
      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-2 text-center text-gray-500">Sin médicos</td></tr>`;
        return;
      }
      data.forEach(m => {
        tbody.innerHTML += `
          <tr>
            <td class="px-4 py-2">${m.id_medico}</td>
            <td class="px-4 py-2">${m.nombre}</td>
            <td class="px-4 py-2">${m.especialidad}</td>
            <td class="px-4 py-2 text-center">
              <button onclick="abrirModal(${m.id_medico}, '${m.nombre}', '${m.especialidad}')" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">Agregar Paciente</button>
            </td>
          </tr>
        `;
      });
    }

    // FILTRAR MEDICOS
    document.getElementById("buscar-medico").addEventListener("input", e => {
      const texto = e.target.value.toLowerCase();
      const filtrados = medicosData.filter(m => m.nombre.toLowerCase().includes(texto));
      mostrarMedicos(filtrados);
    });

    // -----------------------------
    // CARGAR GENEROS
    // -----------------------------
    async function cargarGeneros() {
      const select = document.querySelector('select[name="idgenero_fk"]');
      try {
        const res = await fetch(`${API_BASE}/generos/`);
        generosData = await res.json();
        generosData.forEach(g => {
          const opt = document.createElement('option');
          opt.value = g.id_genero;
          opt.textContent = g.nombre;
          select.appendChild(opt);
        });
      } catch(e) { console.error(e); }
    }

    // -----------------------------
    // ENVIAR PACIENTE
    // -----------------------------
    document.getElementById("formPaciente").addEventListener("submit", async function(e) {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(this));
      const payload = {
        id_paciente: formData.id_paciente,
        nombrepaciente: formData.nombrepaciente,
        apellidopaciente: formData.apellidopaciente,
        edad: parseInt(formData.edad),
        idgenero_fk: parseInt(formData.idgenero_fk),
        fechaingreso: formData.fechaingreso,
        diagnosticopaciente: formData.diagnosticopaciente,
        idmedicos_fk: parseInt(formData.idmedicos_fk),
        especialidad: formData.especialidad,
        aseguradora: formData.aseguradora
      };
      try {
        const res = await fetch(`${API_BASE}/senso/`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });
        if(res.ok){
          alert("✅ Paciente agregado correctamente");
          cerrarModalPaciente();
          cargarSenso();
        } else {
          const error = await res.json();
          console.error(error);
          alert("⚠ Error al agregar paciente");
        }
      } catch(err) {
        console.error(err);
        alert("❌ Error de conexión con la API");
      }
    });

    // -----------------------------
    // CARGAR PACIENTES
    // -----------------------------
    async function cargarSenso() {
      try {
        const res = await fetch(`${API_BASE}/senso/`);
        sensoData = await res.json();
        mostrarResultados(sensoData);
      } catch(err) { console.error(err); }
    }

    function mostrarResultados(data) {
      const tbody = document.getElementById("tbody-resultados");
      tbody.innerHTML = "";

      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="13" class="px-4 py-2 text-center text-gray-500">Sin resultados</td></tr>`;
        return;
      }

      const hoy = new Date();
      const user = JSON.parse(localStorage.getItem("user"));
      const rolUsuario = user?.role;

      data.forEach(s => {
        const fechaIngreso = new Date(s.fechaingreso);
        const diasTranscurridos = Math.floor((hoy - fechaIngreso) / (1000*60*60*24));

        let botonesAcciones = "";
        if(rolUsuario==="Administrador"){
          botonesAcciones = `<button onclick="modificarSenso(${s.idsenso})" class=" bg-yellow-400 text-white px-2 py-1 rounded hover:bg-yellow-500">Modificar</button>
                             <button onclick="eliminarSenso(${s.idsenso})" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Eliminar</button>`;
        } else if(rolUsuario==="Empleado"){
          botonesAcciones = `<button onclick="modificarSenso(${s.idsenso})" class="bg-yellow-400 text-white px-2 py-1 rounded hover:bg-yellow-500">Modificar</button>`;
        } else {
          botonesAcciones = `<span class="text-gray-400 text-sm">No autorizado</span>`;
        }

        tbody.innerHTML += `<tr>
          <td class="px-4 py-2">${s.id_paciente}</td>
          <td class="px-4 py-2">${s.nombrepaciente}</td>
          <td class="px-4 py-2">${s.apellidopaciente}</td>
          <td class="px-4 py-2">${s.edad}</td>
          <td class="px-4 py-2">${s.genero?.nombre || "Sin asignar"}</td>
          <td class="px-4 py-2">${s.fechaingreso}</td>
          <td class="px-4 py-2">${s.diagnosticopaciente}</td>
          <td class="px-4 py-2">${s.medico?.nombre || "Sin asignar"}</td>
          <td class="px-4 py-2">${s.especialidad}</td>
          <td class="px-4 py-2">${s.aseguradora}</td>
          <td class="px-4 py-2">${s.fechaalta || ""}</td>
          <td class="px-4 py-2 text-center"><input type="checkbox" onchange="darDeAlta(${s.idsenso}, this)" ${s.fechaalta?"checked disabled":""} class="cursor-pointer"></td>
          <td class="px-4 py-2 text-center">${diasTranscurridos}</td>
          <td class="px-4 py-2 text-center">${botonesAcciones}</td>
        </tr>`;
      });
    }

    // -----------------------------
    // FILTRO BUSQUEDA
    // -----------------------------
    document.getElementById("form-buscar").addEventListener("submit", e => {
      e.preventDefault();
      const nombre = document.getElementById("buscar-nombre").value.toLowerCase();
      const apellido = document.getElementById("buscar-apellido").value.toLowerCase();
      const desde = document.getElementById("fecha-desde").value;
      const hasta = document.getElementById("fecha-hasta").value;

      const filtrados = sensoData.filter(p => {
        const fn = p.nombrepaciente.toLowerCase().includes(nombre);
        const fa = p.apellidopaciente.toLowerCase().includes(apellido);
        const ffecha = (!desde || new Date(p.fechaingreso) >= new Date(desde)) &&
                       (!hasta || new Date(p.fechaingreso) <= new Date(hasta));
        return fn && fa && ffecha;
      });

      mostrarResultados(filtrados);
    });

    // -----------------------------
    // TOGGLE SECCIONES
    // -----------------------------
    document.getElementById("btn-buscar").addEventListener("click", () => {
      document.getElementById("seccion-buscar").classList.remove("hidden");
      document.getElementById("seccion-cargar").classList.add("hidden");
    });
    document.getElementById("btn-cargar").addEventListener("click", () => {
      document.getElementById("seccion-buscar").classList.add("hidden");
      document.getElementById("seccion-cargar").classList.remove("hidden");
    });
    //modicar senso
    // MODIFICAR PACIENTE
function modificarSenso(idsenso) {
  const paciente = sensoData.find(s => s.idsenso === idsenso);
  if (!paciente) return alert("Paciente no encontrado");

  // Llenar los campos del modal
  document.getElementById("mod-idsenso").value = paciente.idsenso;
  document.getElementById("mod-nombre").value = paciente.nombrepaciente;
  document.getElementById("mod-apellido").value = paciente.apellidopaciente;
  document.getElementById("mod-edad").value = paciente.edad;
  document.getElementById("mod-fechaingreso").value = paciente.fechaingreso.split('T')[0];
  document.getElementById("mod-aseguradora").value = paciente.aseguradora || "";
  document.getElementById("mod-diagnosticopaciente").value = paciente.diagnosticopaciente || "";
  document.getElementById("mod-diasInstancia").value = paciente.diasInstancia || 0;

  // Mostrar modal
  document.getElementById("modalModificar").classList.remove("hidden");
}

// Cerrar modal
function cerrarModal() {
  document.getElementById("modalModificar").classList.add("hidden");
}

// Enviar formulario de modificación
document.getElementById("formModificar").addEventListener("submit", async function (e) {
  e.preventDefault();

  const idsenso = document.getElementById("mod-idsenso").value;

  const payload = {
    nombrepaciente: document.getElementById("mod-nombre").value,
    apellidopaciente: document.getElementById("mod-apellido").value,
    edad: parseInt(document.getElementById("mod-edad").value),
    fechaingreso: document.getElementById("mod-fechaingreso").value,
    aseguradora: document.getElementById("mod-aseguradora").value,
    diagnosticopaciente: document.getElementById("mod-diagnosticopaciente").value,
    diasInstancia: parseInt(document.getElementById("mod-diasInstancia").value)  // ← NUEVO CAMPO
  };

  try {
    const res = await fetch(`${API_BASE}/senso/${idsenso}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error("Error al modificar");

    alert("Senso actualizado correctamente ✅");
    cerrarModal();
    cargarSenso(); // refrescar tabla
  } catch (err) {
    console.error(err);
    alert("Error al modificar, revisa la consola ⚠️");
  }
});

    // -----------------------------
    // INICIALIZACIÓN
    // -----------------------------
    window.addEventListener("DOMContentLoaded", () => {
      cargarMedicos();
      cargarGeneros();
      cargarSenso();
    });

  </script>

</body>
</html>
