<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestión de censo</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
     <nav class="bg-red-600 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="text-white text-xl font-bold">Censo</div>
            <ul class="flex space-x-4">
                <li><a href="./home.html" class="text-white hover:text-gray-200">Inicio</a></li>
                
            </ul>
        </div>
    </nav>
<div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-8 text-center">Gestión de Censo</h1>

    <!-- Navegación -->
    <div class="flex justify-center mb-6">
        <button id="btn-buscar" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Buscar</button>
        <button id="btn-cargar" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Cargar</button>
    </div>

    <!-- Sección Buscar -->
    <div id="seccion-buscar" class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-2xl font-bold mb-4">Buscar Censo</h2>
        <form id="form-buscar" class="space-y-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nombre</label>
                    <input type="text" id="buscar-nombre" class="input-field" placeholder="Ej: Ana">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Apellido</label>
                    <input type="text" id="buscar-apellido" class="input-field" placeholder="Ej: Pérez">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Desde</label>
                    <input type="date" id="fecha-desde" class="input-field">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Hasta</label>
                    <input type="date" id="fecha-hasta" class="input-field">
                </div>
            </div>
            <div class="flex justify-end">
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Buscar</button>
            </div>
        </form>

        <!-- Resultados -->
        <div id="resultados" class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-300">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Codigo Paciente</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Apellido</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Edad</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Género</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha Ingreso</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Diagnóstico</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Medico</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Especialidad</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Aseguradora</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fecha Alta</th>
                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Alta</th>
                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Días Ingreso </th>
                         <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tbody-resultados" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="11" class="px-4 py-2 text-center text-gray-500">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Sección Cargar -->
    <div id="seccion-cargar" class="bg-white p-6 rounded-lg shadow-md hidden">
        <h2 class="text-2xl font-bold mb-4">Cargar Nuevo Senso</h2>
           <form id="sensoForm" class="space-y-4">
      <!-- ID Paciente -->
      <div>
        <label>ID Paciente</label>
        <input name="id_paciente" required maxlength="25"
          class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>
        <!-- Nombre Paciente  diasInstancia-->
        <div>
                <label> Dias De Hospitalizacion  </label>
                <input name="diasInstancia" type="number" required min="0" max="200"
                class="mt-1 w-full px-3 py-2 border rounded-md">
            </div>
      <!-- Nombre Paciente  -->
      <div>
        <label>Nombre Paciente</label>
        <input name="nombrepaciente" required maxlength="150"
          class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>

      <!-- Apellido Paciente -->
      <div>
        <label>Apellido Paciente</label>
        <input name="apellidopaciente" required maxlength="150"
          class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>

      <!-- Edad -->
      <div>
        <label>Edad</label>
        <input type="number" name="edad" min="0" required
          class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>

      <!-- Género -->
      <div>
        <label>Género</label>
        <select name="idgenero_fk" required class="mt-1 w-full px-3 py-2 border rounded-md">
          <option value="">Seleccione un género</option>
        </select>
      </div>

      <!-- Fecha ingreso -->
      <div>
        <label>Fecha Ingreso</label>
        <input type="date" name="fechaingreso" required class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>

      <!-- Diagnóstico -->
      <div>
        <label>Diagnóstico Paciente</label>
        <textarea name="diagnosticopaciente" maxlength="250" rows="3" required class="mt-1 w-full px-3 py-2 border rounded-md"></textarea>
      </div>

      <!-- Médico -->
      <div>
        <label>Médico</label>
        <select name="idmedicos_fk" required class="mt-1 w-full px-3 py-2 border rounded-md">
          <option value="">Cargando médicos...</option>
        </select>
      </div>

      <!-- Especialidad -->
      <div>
        <label>Especialidad</label>
        <input name="especialidad" readonly class="mt-1 w-full px-3 py-2 border rounded-md bg-gray-100">
      </div>

      <!-- Aseguradora -->
      <div>
        <label>Aseguradora</label>
        <input name="aseguradora" maxlength="150" required class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>

      <!-- Botón -->
      <div class="flex justify-end">
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Guardar</button>
      </div>
    </form>
    </div>
</div>
<!--modal -->
<!-- Modal para modificar paciente -->
<div id="modalModificar" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
  <div class="bg-white p-6 rounded-lg w-96">
    <h2 class="text-xl font-bold mb-4">Modificar Senso</h2>
    <form id="formModificar" class="space-y-4">
      <input type="hidden" name="idsenso" id="mod-idsenso">

      <div>
        <label>Nombre Paciente</label>
        <input type="text" name="nombrepaciente" id="mod-nombre" class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>
      <div>
        <label>Apellido Paciente</label>
        <input type="text" name="apellidopaciente" id="mod-apellido" class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>
      <div>
        <label>Edad</label>
        <input type="number" name="edad" id="mod-edad" class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>
      <div>
        <label>Fecha Ingreso</label>
        <input type="date" name="fechaingreso" id="mod-fechaingreso" class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>
    <div>
      <div>
        <label>diagnostico Del Paciente</label>
        <textarea name="diagnosticopaciente" id="mod-diagnosticopaciente" maxlength="250" rows="3" required class="mt-1 w-full px-3 py-2 border rounded-md"></textarea>
      </div>   
      <div>
        <label>Aseguradora</label>
         <input name="aseguradora" id="mod-aseguradora" maxlength="150" required class="mt-1 w-full px-3 py-2 border rounded-md">
      </div>
      <div class="flex justify-end space-x-2">
        <button type="button" onclick="cerrarModal()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancelar</button>
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
const API_BASE = "https://backendsenso.onrender.com";
let sensoData = [];
//carga 
document.addEventListener("DOMContentLoaded", () => {
  cargarMedicos(); // carga lista de médicos al iniciar
  cargarSenso();   // carga tabla de pacientes
});
async function cargarMedicos() {
  const select = document.getElementById("mod-idmedicos_fk");
  select.innerHTML = '<option value="">Seleccione un médico</option>';
  const res = await fetch(`${API_BASE}/medicos/`);
  medicosData = await res.json();

  medicosData.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m.id_medico;
    opt.textContent = m.nombre;
    select.appendChild(opt);
  });
}

// Alternar secciones
const seccionBuscar = document.getElementById("seccion-buscar");
const seccionCargar = document.getElementById("seccion-cargar");
document.getElementById("btn-buscar").addEventListener("click", () => {
  seccionBuscar.classList.remove("hidden");
  seccionCargar.classList.add("hidden");
});
document.getElementById("btn-cargar").addEventListener("click", () => {
  seccionCargar.classList.remove("hidden");
  seccionBuscar.classList.add("hidden");
});

// Fecha actual por defecto
function setFechasHoy() {
  const hoy = new Date().toISOString().split("T")[0];
  document.getElementById("fecha-desde").value = hoy;
  document.getElementById("fecha-hasta").value = hoy;
}
setFechasHoy();

// Cargar datos
async function cargarSenso() {
  try {
    const res = await fetch(`${API_BASE}/senso/`);
    sensoData = await res.json();
    mostrarResultados(sensoData);
  } catch (err) {
    console.error(err);
  }
}

// Mostrar resultados
// ✅ Obtener rol desde localStorage (guardado en el login)
const user = JSON.parse(localStorage.getItem("user"));
const rolUsuario = user?.role; // "Administrador", "Empleado", "Invitado"

function mostrarResultados(data) {
  const tbody = document.getElementById("tbody-resultados");
  tbody.innerHTML = "";

  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="13" class="px-4 py-2 text-center text-gray-500">Sin resultados</td></tr>`;
    return;
  }

  const hoy = new Date();

  data.forEach(s => {
    const fechaIngreso = new Date(s.fechaingreso);
    const diasTranscurridos = Math.floor((hoy - fechaIngreso) / (1000 * 60 * 60 * 24));

    // ✅ Mostrar botones según rol
    let botonesAcciones = "";
    if (rolUsuario === "Administrador") {
      botonesAcciones = `
        <button onclick="modificarSenso(${s.idsenso})" class=" bg-yellow-400 text-white px-2 py-1 rounded hover:bg-yellow-500">Modificar</button>
        <button onclick="eliminarSenso(${s.idsenso})" class="bg-red-500 text-white px-2 py-2 rounded hover:bg-red-600">Eliminar</button>
      `;
    } else if (rolUsuario === "Empleado") {
      botonesAcciones = `
        <button onclick="modificarSenso(${s.idsenso})" class="bg-yellow-400 text-white px-2 py-1 rounded hover:bg-yellow-500">Modificar</button>
      `;
    } else {
      botonesAcciones = `<span class="text-gray-400 text-sm">No autorizado</span>`;
    }

    tbody.innerHTML += `
      <tr>
        <td class="px-4 py-2">${s.id_paciente}</td>
        <td class="px-4 py-2">${s.nombrepaciente}</td>
        <td class="px-4 py-2">${s.apellidopaciente}</td>
        <td class="px-4 py-2">${s.edad}</td>
        <td class="px-4 py-2">${s.genero?.nombre || "Sin asignar"}</td>
        <td class="px-4 py-2">${s.fechaingreso}</td>
        <td class="px-4 py-2">${s.diagnosticopaciente}</td>
        <td class="px-4 py-2">${s.medico?.nombre || "Sin asignar"}</td>
        <td class="px-4 py-2">${s.especialidad}</td>
        <td class="px-4 py-2">${s.aseguradora}</td>
        <td class="px-4 py-2">${s.fechaalta || ""}</td>
        <td class="px-4 py-2 text-center">
          <input 
            type="checkbox" 
            onchange="darDeAlta(${s.idsenso}, this)" 
            ${s.fechaalta ? "checked disabled" : ""} 
            class="cursor-pointer"
          >
        </td>
        <td class="px-4 py-2 text-center">${diasTranscurridos}</td>
        <td class="px-4 py-2 text-center">
          ${botonesAcciones}
        </td>
      </tr>
    `;
  });
}




// Filtro de búsqueda
document.getElementById("form-buscar").addEventListener("submit", e => {
  e.preventDefault();
  const nombre = document.getElementById("buscar-nombre").value.toLowerCase();
  const apellido = document.getElementById("buscar-apellido").value.toLowerCase();
  const desde = new Date(document.getElementById("fecha-desde").value);
  const hasta = new Date(document.getElementById("fecha-hasta").value);

  const filtrados = sensoData.filter(s => {
    const fechaIngreso = new Date(s.fechaingreso);
    return (
      (!nombre || s.nombrepaciente.toLowerCase().includes(nombre)) &&
      (!apellido || s.apellidopaciente.toLowerCase().includes(apellido)) &&
      fechaIngreso >= desde && fechaIngreso <= hasta
    );
  });
  mostrarResultados(filtrados);
});
// acciones de eliminar y modificar 
// acciones de eliminar y modificar 
function modificarSenso(idsenso) {
  const paciente = sensoData.find(s => s.idsenso === idsenso);
  if (!paciente) return alert("Paciente no encontrado");

  // Datos principales
  document.getElementById("mod-idsenso").value = paciente.idsenso;
  document.getElementById("mod-nombre").value = paciente.nombrepaciente;
  document.getElementById("mod-apellido").value = paciente.apellidopaciente;
  document.getElementById("mod-edad").value = paciente.edad;
  document.getElementById("mod-fechaingreso").value = paciente.fechaingreso.split('T')[0];
  document.getElementById("mod-aseguradora").value = paciente.aseguradora || "";
  document.getElementById("mod-diagnosticopaciente").value = paciente.diagnosticopaciente || "";


  // Mostrar modal
  document.getElementById("modalModificar").classList.remove("hidden");
}

function cerrarModal() {
  document.getElementById("modalModificar").classList.add("hidden");
}

document.getElementById("formModificar").addEventListener("submit", async function (e) {
  e.preventDefault();

  const idsenso = document.getElementById("mod-idsenso").value;

  const payload = {
    nombrepaciente: document.getElementById("mod-nombre").value,
    apellidopaciente: document.getElementById("mod-apellido").value,
    edad: parseInt(document.getElementById("mod-edad").value),
    fechaingreso: document.getElementById("mod-fechaingreso").value,
    aseguradora: document.getElementById("mod-aseguradora").value,
    diagnosticopaciente: document.getElementById("mod-diagnosticopaciente").value,
   
  };

  try {
    const res = await fetch(`${API_BASE}/senso/${idsenso}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error("Error al modificar");

    alert("Senso actualizado correctamente ✅");
    cerrarModal();
    cargarSenso(); // refrescar tabla
  } catch (err) {
    console.error(err);
    alert("Error al modificar, revisa la consola ⚠️");
  }
});



//ELIMINAR 
async function eliminarSenso(idsenso) {
  if (!confirm("¿Estás seguro de eliminar este paciente? Esta acción no se puede deshacer.")) {
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/senso/${idsenso}`, {
      method: "DELETE"
    });

    if (!res.ok) throw new Error("Error al eliminar");

    alert("Paciente eliminado ✅");
    cargarSenso(); // refresca tabla
  } catch(err) {
    console.error(err);
    alert("Error al eliminar, revisa consola ⚠️");
  }
}
// Dar de alta paciente
async function darDeAlta(idsenso, checkbox) {
    if(!confirm("¿Dar de alta al paciente?")) {
        checkbox.checked = false;
        return;
    }

    // Fecha y hora actual en formato ISO (YYYY-MM-DDTHH:MM:SS)
    const fechaAlta = new Date().toISOString();

    try {
        const res = await fetch(`${API_BASE}/senso/${idsenso}`, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ fechaalta: fechaAlta })
        });

        if (!res.ok) throw new Error("No se pudo actualizar");

        alert("✅ Paciente dado de alta");
        checkbox.disabled = true;       // bloquea checkbox
        cargarSenso();                  // refresca tabla automáticamente
    } catch(err) {
        console.error(err);
        alert("⚠️ Error al actualizar fecha de alta");
        checkbox.checked = false;       // revertir checkbox
    }
}


// Inicializar
cargarSenso();
//post

let medicosData = [];

// Cargar géneros
async function cargarGeneros() {
  const select = document.querySelector('select[name="idgenero_fk"]');
  try {
    const res = await fetch(`${API_BASE}/generos/`);
    const generos = await res.json();
    generos.forEach(g => {
      const opt = document.createElement('option');
      opt.value = g.id_genero;
      opt.textContent = g.nombre;
      select.appendChild(opt);
    });
  } catch(e) { console.error(e); }
}

// Cargar médicos
async function cargarMedicos() {
  const select = document.querySelector('select[name="idmedicos_fk"]');
  try {
    const res = await fetch(`${API_BASE}/medicos/`);
    medicosData = await res.json();
    select.innerHTML = '<option value="">Seleccione un médico</option>';
    medicosData.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.id_medico;          // coincide con Pydantic
      opt.textContent = m.nombre;
      opt.dataset.especialidad = m.especialidad; // especialidad para JS
      select.appendChild(opt);
    });
  } catch(e) { console.error(e); }
}

// Actualizar especialidad al seleccionar médico
document.querySelector('select[name="idmedicos_fk"]').addEventListener('change', function() {
  const selected = this.selectedOptions[0];
  const espInput = document.querySelector('input[name="especialidad"]');
  espInput.value = selected?.dataset?.especialidad || "";
});

// Función para transformar los datos del formulario al formato que espera FastAPI
const transformarData = (data) => {
  return {
    id_paciente: data.id_paciente,
    diasInstancia: parseInt(data.diasInstancia || 0),
    nombrepaciente: data.nombrepaciente,
    apellidopaciente: data.apellidopaciente,
    edad: parseInt(data.edad),
    idgenero_fk: parseInt(data.idgenero_fk),  // Debes enviar el ID del género (no texto)
    fechaingreso: data.fechaingreso,
    diagnosticopaciente: data.diagnosticopaciente,
    idmedicos_fk: parseInt(data.idmedicos_fk), // ID del médico desde select/input
    especialidad: data.especialidad,           // Puedes tomarla desde el médico seleccionado
    aseguradora: data.aseguradora || "Sin aseguradora",
    fechaalta: data.fechaalta || null
  };
};

// Enviar formulario
document.getElementById("sensoForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  // Capturamos los datos del formulario
  const formData = Object.fromEntries(new FormData(this));
  console.log("Formulario original:", formData);

  // Transformamos antes de enviar
  const payload = transformarData(formData);
  console.log("Payload enviado al backend:", payload);

  try {
    const res = await fetch(`${API_BASE}/senso/`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if(res.ok){
      alert("✅ Senso guardado correctamente");
      this.reset();
      document.querySelector('input[name="especialidad"]').value = "";
    } else {
      const error = await res.json();
      console.error("❌ Error POST /senso:", error);
      alert("⚠ Error al guardar, revisa la consola");
    }
  } catch(err){
    console.error(err);
    alert("❌ Error de conexión con la API");
  }
});


// Inicializar
cargarGeneros();
cargarMedicos();
</script>

<style>
.input-field {
  margin-top: 0.25rem;
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  box-shadow: inset 0 1px 2px rgb(0 0 0 / 0.05);
}
</style>
</body>
</html>
